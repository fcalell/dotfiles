#!/usr/bin/env bash
# Install packages declaratively based on OS

set -euo pipefail

{{ if eq .chezmoi.os "darwin" -}}
# macOS - Install via Homebrew
echo "Installing packages via Homebrew..."

brew bundle --no-lock --file=/dev/stdin <<EOF
{{ range $name, $pkg := . -}}
{{- if kindIs "map" $pkg -}}
{{- if hasKey $pkg "macos" -}}
{{- if hasKey $pkg.macos "tap" -}}
{{- $tapParts := splitList "/" $pkg.macos.tap }}
tap {{ index $tapParts 0 | quote }}/{{ index $tapParts 1 | quote }}
{{ end -}}
{{- end -}}
{{- end -}}
{{- end -}}
{{ range $name, $pkg := . -}}
{{- if kindIs "map" $pkg -}}
{{- if hasKey $pkg "macos" -}}
{{- if hasKey $pkg.macos "brew" }}
brew {{ $pkg.macos.brew | quote }}{{- if hasKey $pkg.macos "args" }}, args: {{ $pkg.macos.args | toJson }}{{- end }}
{{ else if hasKey $pkg.macos "cask" }}
cask {{ $pkg.macos.cask | quote }}{{- if hasKey $pkg.macos "args" }}, args: {{ $pkg.macos.args | toJson }}{{- end }}
{{ end -}}
{{- end -}}
{{- end -}}
{{- end -}}
EOF

echo "✓ Homebrew packages installed"
{{ end -}}

{{ if eq .chezmoi.os "linux" -}}
# Linux - Install via pacman and paru (Arch Linux)
echo "Installing packages via pacman..."

# Update package database
sudo pacman -Sy

# Build pacman package list and install
pacman_packages=(
{{ range $name, $pkg := . -}}
{{- if kindIs "map" $pkg -}}
{{- if hasKey $pkg "linux" -}}
{{- if hasKey $pkg.linux "pacman" }}
  {{ $pkg.linux.pacman | quote }}
{{ end -}}
{{- end -}}
{{- end -}}
{{- end -}}
)

if [ ${#pacman_packages[@]} -gt 0 ]; then
  sudo pacman -S --needed "${pacman_packages[@]}"
  echo "✓ Official packages installed"
fi

# Build AUR package list and install
aur_packages=(
{{ range $name, $pkg := . -}}
{{- if kindIs "map" $pkg -}}
{{- if hasKey $pkg "linux" -}}
{{- if hasKey $pkg.linux "aur" }}
  {{ $pkg.linux.aur | quote }}
{{ end -}}
{{- end -}}
{{- end -}}
{{- end -}}
)

if [ ${#aur_packages[@]} -gt 0 ]; then
  echo "Installing AUR packages via paru..."
  paru -S --needed "${aur_packages[@]}"
  echo "✓ AUR packages installed"
fi
{{ end -}}

echo "✓ Package installation complete"
